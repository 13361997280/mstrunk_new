<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.qianwang.mapper.user.BusiUserLoginBlackListMapper">

    <resultMap id="BaseResultMap" type="com.qianwang.dao.domain.user.UnusualUser" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Jan 20 13:37:52 CST 2015.
        -->
        <result column="order_id" property="orderId" jdbcType="INTEGER" />
        <result column="deal_result" property="dealResult" jdbcType="INTEGER" />
    </resultMap>

    <select id="getBlackUser" resultType="java.util.Map" parameterType="java.util.Map">
        SELECT
        b.operate_time operateTime,
        b.user_id userId,
        b.username userName,
        b.create_time createTime,
        d.reason_detail reasonDetail,
        b.status
        FROM
        froze.busi_user_login_blacklist b,froze.dict_user_login_blacklist_reason d
        WHERE
        b.operate_time >= #{startDate} AND b.operate_time <![CDATA[ < ]]>  (#{endDate} + interval 1 day)
        AND
        b.lock_reason_type = d.id
        <if test="userName != '' and userName != null">
            AND b.username = #{userName}
        </if>
        <if test="lockReasonType != -1 and lockReasonType != null">
            AND b.lock_reason_type = #{lockReasonType}
        </if>
        ORDER BY b.operate_time desc
        limit 200
    </select>
    <select id="getBlackUserDayGroup" resultType="java.util.Map"
            parameterType="java.util.Map">
        SELECT date_format(operate_time,'%Y-%m-%d') operateTime,
        COUNT(user_id) blackUserCount
        FROM froze.busi_user_login_blacklist
        WHERE
        operate_time BETWEEN #{startDate} AND #{endDate}
        <if test="userName != '' and userName != null">
            AND username = #{userName}
        </if>
        <if test="lockReasonType != -1 and lockReasonType != null">
            AND lock_reason_type = #{lockReasonType}
        </if>
        GROUP BY date_format(operate_time,'%Y-%m-%d')
    </select>
    <select id="getBlackUserHourGroup" resultType="java.util.Map"
            parameterType="java.util.Map">
        SELECT
        operate_time operateTime,
        COUNT(user_id) blackUserCount
        FROM froze.busi_user_login_blacklist
        WHERE
        operate_time >= #{startDate} AND operate_time <![CDATA[ < ]]>  (#{startDate} + interval 1 day)
        <if test="userName != '' and userName != null">
            AND username = #{userName}
        </if>
        <if test="lockReasonType != -1 and lockReasonType != null">
            AND lock_reason_type = #{lockReasonType}
        </if>
        GROUP BY date_format(operate_time,'%H')
    </select>
    <select id="getBlackUserReason" resultType="java.util.Map"
            parameterType="java.lang.Integer">
		SELECT id, reason_detail name
		FROM
		froze.dict_user_login_blacklist_reason
	</select>


    <select id="getUnBlackUser" resultType="java.util.Map" parameterType="java.util.Map">
        select distinct t.operate_time operateTime,t1.id userId,t.username userName,t1.create_time
        createTime,t.lock_reason reasonDetail,t.unlock_reason unReasonDetail,'已解封' as `status` from
        qianwang365.qw_login_blacklist t,
        hyip.hyip_user t1
        where t.operate_time >= #{startDate} AND t.operate_time <![CDATA[ < ]]>  (#{endDate} + interval 1 day)
        and t1.enabled = 1
        and t.username = t1.username
        <if test="userName != '' and userName != null">
            and t.username = #{userName}
        </if>
        order by t.operate_time desc
    </select>

    <select id="getUnBlackUserDayGroup" resultType="java.util.Map"
            parameterType="java.util.Map">
        select date_format(t.operate_time,'%Y-%m-%d') operateTime,
        count(t.username) as unBlackUserCount
        from
        qianwang365.qw_login_blacklist t
        where t.status = 1
        and t.operate_time BETWEEN #{startDate} AND #{endDate}
        <if test="userName != '' and userName != null">
            AND t.username = #{userName}
        </if>
        group by date_format(t.operate_time,'%Y-%m-%d')
    </select>

    <select id="getUnBlackUserHourGroup" resultType="java.util.Map"
            parameterType="java.util.Map">
        select t.operate_time operateTime,
        count(t.username) as unBlackUserCount
        from
        qianwang365.qw_login_blacklist t
        where t.status = 1
        and t.operate_time >= #{startDate} AND t.operate_time <![CDATA[ < ]]>  (#{startDate} + interval 1 day)
        <if test="userName != '' and userName != null">
            AND t.username = #{userName}
        </if>
        GROUP BY date_format(t.operate_time,'%H')
    </select>

    <select id="getUnBlackUserByTime" resultType="java.util.Map"
            parameterType="java.util.Map">
        select count(distinct t.username) as unBlackCnt,
        substr(unlock_reason,locate('【',unlock_reason)+1,(locate('】',unlock_reason)-locate('【',unlock_reason))-1) as userName
        from
        qianwang365.qw_login_blacklist t
        where t.status = 1
        and t.operate_time BETWEEN #{startDate} AND #{endDate}
        group by substr(unlock_reason,locate('【',unlock_reason)+1,(locate('】',unlock_reason)-locate('【',unlock_reason))-1)
    </select>

    <select id="getUnBlackUserByDay" resultType="java.util.Map"
            parameterType="java.util.Map">
        select count(distinct t.username) as unBlackCnt,
        substr(unlock_reason,locate('【',unlock_reason)+1,(locate('】',unlock_reason)-locate('【',unlock_reason))-1) as userName
        from
        qianwang365.qw_login_blacklist t
        where t.status = 1
        and t.operate_time BETWEEN #{startDate} AND #{endDate}
        group by substr(unlock_reason,locate('【',unlock_reason)+1,(locate('】',unlock_reason)-locate('【',unlock_reason))-1)
    </select>
   <!--查询异常订单信息-->
    <select id="getYiChangUser" resultType="java.util.Map" parameterType="java.util.Map">
        select orderId,userId,shopId,goodsId,goods_name,createTime,payTime,
        total_amount,
        if(round(ifnull(if(voucher=0,voucher,voucher-service_fee)/total_amount,0),3) <![CDATA[ < ]]> 0,0,
        round(ifnull(if(voucher=0,voucher,voucher-service_fee)/total_amount,0),3)) bblv,
        dealResult
        from
        (select o.order_id AS orderId,o.user_id AS userId,o.shop_id AS shopId,t.goods_id AS goodsId,IFNULL(t.goods_name,'') goods_name,
        o.create_time AS createTime,  IFNULL(o.pay_time,'') payTime,
        round(if(t.pre_price != 0,t.pre_price,o.total_amount)/100,2) total_amount,
        ifnull(round(if(t.pre_price !=  0,o.field2/o.total_amount*t.pre_price/100,o.field2/100),2),0) voucher,
        ifnull(if(t.pre_price !=  0,2/o.total_amount*t.pre_price,4),0) service_fee,
        m.deal_result AS dealResult
        FROM oc1.nbiz_order_base o,oc1.nbiz_order_item t,froze.busi_merchant_trade_monitor m
        where o.order_id = t.order_id
        and o.order_id = m.order_id
        and o.pay_time is not null
        and m.deal_time >=CURRENT_DATE() - interval 1 day
        and m.deal_result = 1) t
        order by orderid;
    </select>

    <update id="updateYiChangUser" parameterType="com.qianwang.dao.domain.user.UnusualUser" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Jan 20 13:37:52 CST 2015.
        -->
        update froze.busi_merchant_trade_monitor
        set deal_result = #{dealResult,jdbcType=INTEGER}
        WHERE order_id = #{orderId}
    </update>
</mapper>
