<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.qianwang.mapper.user.HeavyPUserStatMapper" >
  <resultMap id="BaseResultMap" type="com.qianwang.dao.domain.user.HeavyPUserStat" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 24 13:33:41 CST 2014.
    -->
    <id column="p_user_id" property="pUserId" jdbcType="INTEGER" />
    <result column="c_count" property="cCount" jdbcType="INTEGER" />
    <result column="register_reward" property="registerReward" jdbcType="DECIMAL" />
    <result column="c_reward_count" property="cRewardCount" jdbcType="DECIMAL" />
    <result column="c_reward" property="cReward" jdbcType="DECIMAL" />
    <result column="p_reward" property="pReward" jdbcType="DECIMAL" />
    <result column="d1" property="d1" jdbcType="DECIMAL" />
    <result column="d3" property="d3" jdbcType="DECIMAL" />
    <result column="d7" property="d7" jdbcType="DECIMAL" />
    <result column="d17_verify" property="d17Verify" jdbcType="DECIMAL" />
    <result column="d30" property="d30" jdbcType="DECIMAL" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 24 13:33:41 CST 2014.
    -->
    p_user_id, c_count, register_reward, c_reward_count, c_reward, p_reward, d1, d3, 
    d7, d17_verify, d30
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 24 13:33:41 CST 2014.
    -->
    select 
    <include refid="Base_Column_List" />
    from heavy_p_user_stat
    where p_user_id = #{pUserId,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 24 13:33:41 CST 2014.
    -->
    delete from heavy_p_user_stat
    where p_user_id = #{pUserId,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.qianwang.dao.domain.user.HeavyPUserStat" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 24 13:33:41 CST 2014.
    -->
    insert into heavy_p_user_stat (p_user_id, c_count, register_reward, 
      c_reward_count, c_reward, p_reward, 
      d1, d3, d7, d17_verify, 
      d30)
    values (#{pUserId,jdbcType=INTEGER}, #{cCount,jdbcType=INTEGER}, #{registerReward,jdbcType=DECIMAL}, 
      #{cRewardCount,jdbcType=DECIMAL}, #{cReward,jdbcType=DECIMAL}, #{pReward,jdbcType=DECIMAL}, 
      #{d1,jdbcType=DECIMAL}, #{d3,jdbcType=DECIMAL}, #{d7,jdbcType=DECIMAL}, #{d17Verify,jdbcType=DECIMAL}, 
      #{d30,jdbcType=DECIMAL})
  </insert>
  <insert id="insertSelective" parameterType="com.qianwang.dao.domain.user.HeavyPUserStat" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 24 13:33:41 CST 2014.
    -->
    insert into heavy_p_user_stat
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="pUserId != null" >
        p_user_id,
      </if>
      <if test="cCount != null" >
        c_count,
      </if>
      <if test="registerReward != null" >
        register_reward,
      </if>
      <if test="cRewardCount != null" >
        c_reward_count,
      </if>
      <if test="cReward != null" >
        c_reward,
      </if>
      <if test="pReward != null" >
        p_reward,
      </if>
      <if test="d1 != null" >
        d1,
      </if>
      <if test="d3 != null" >
        d3,
      </if>
      <if test="d7 != null" >
        d7,
      </if>
      <if test="d17Verify != null" >
        d17_verify,
      </if>
      <if test="d30 != null" >
        d30,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="pUserId != null" >
        #{pUserId,jdbcType=INTEGER},
      </if>
      <if test="cCount != null" >
        #{cCount,jdbcType=INTEGER},
      </if>
      <if test="registerReward != null" >
        #{registerReward,jdbcType=DECIMAL},
      </if>
      <if test="cRewardCount != null" >
        #{cRewardCount,jdbcType=DECIMAL},
      </if>
      <if test="cReward != null" >
        #{cReward,jdbcType=DECIMAL},
      </if>
      <if test="pReward != null" >
        #{pReward,jdbcType=DECIMAL},
      </if>
      <if test="d1 != null" >
        #{d1,jdbcType=DECIMAL},
      </if>
      <if test="d3 != null" >
        #{d3,jdbcType=DECIMAL},
      </if>
      <if test="d7 != null" >
        #{d7,jdbcType=DECIMAL},
      </if>
      <if test="d17Verify != null" >
        #{d17Verify,jdbcType=DECIMAL},
      </if>
      <if test="d30 != null" >
        #{d30,jdbcType=DECIMAL},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.qianwang.dao.domain.user.HeavyPUserStat" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 24 13:33:41 CST 2014.
    -->
    update heavy_p_user_stat
    <set >
      <if test="cCount != null" >
        c_count = #{cCount,jdbcType=INTEGER},
      </if>
      <if test="registerReward != null" >
        register_reward = #{registerReward,jdbcType=DECIMAL},
      </if>
      <if test="cRewardCount != null" >
        c_reward_count = #{cRewardCount,jdbcType=DECIMAL},
      </if>
      <if test="cReward != null" >
        c_reward = #{cReward,jdbcType=DECIMAL},
      </if>
      <if test="pReward != null" >
        p_reward = #{pReward,jdbcType=DECIMAL},
      </if>
      <if test="d1 != null" >
        d1 = #{d1,jdbcType=DECIMAL},
      </if>
      <if test="d3 != null" >
        d3 = #{d3,jdbcType=DECIMAL},
      </if>
      <if test="d7 != null" >
        d7 = #{d7,jdbcType=DECIMAL},
      </if>
      <if test="d17Verify != null" >
        d17_verify = #{d17Verify,jdbcType=DECIMAL},
      </if>
      <if test="d30 != null" >
        d30 = #{d30,jdbcType=DECIMAL},
      </if>
    </set>
    where p_user_id = #{pUserId,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.qianwang.dao.domain.user.HeavyPUserStat" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 24 13:33:41 CST 2014.
    -->
    update heavy_p_user_stat
    set c_count = #{cCount,jdbcType=INTEGER},
      register_reward = #{registerReward,jdbcType=DECIMAL},
      c_reward_count = #{cRewardCount,jdbcType=DECIMAL},
      c_reward = #{cReward,jdbcType=DECIMAL},
      p_reward = #{pReward,jdbcType=DECIMAL},
      d1 = #{d1,jdbcType=DECIMAL},
      d3 = #{d3,jdbcType=DECIMAL},
      d7 = #{d7,jdbcType=DECIMAL},
      d17_verify = #{d17Verify,jdbcType=DECIMAL},
      d30 = #{d30,jdbcType=DECIMAL}
    where p_user_id = #{pUserId,jdbcType=INTEGER}
  </update>
  <!-- 根据用户名查用户ID -->
  <select id="getUserIdByName" resultType="java.util.Map" parameterType="String">
  select * from base_user where username = #{username}
  </select>
  <select id="getPUser" resultType="java.util.Map" parameterType="java.lang.Long" >
    select 
    p_user_id pUserId, c_count cCount, register_reward registerReward, 
	c_reward_count cRewardCount, c_reward cReward, p_reward pReward, d1, d3, 
    d7, d17_verify d17Verify, d30, 
    ifnull(d30/(register_reward+c_reward+p_reward),0) pRoi
    from heavy_p_user_stat
    <if test="presenterId != null and presenterId != '-1'" >
	where p_user_id = #{presenterId}
	</if>
	<if test="sort != null and sort != ''" >
	order by ${sort}
	</if>
	<if test="sort == null or sort == ''" >
	order by p_user_id desc
	</if>
	limit ${start},${length}
  </select>
  
  <select id="getPUserCnt" resultType="java.lang.Integer" parameterType="java.lang.Long" >
    select count(p_user_id)
    from heavy_p_user_stat
    <if test="presenterId != null and presenterId != '-1'" >
	where p_user_id = #{presenterId}
	</if>
  </select>
  
  <select id="getTicketBee" resultType="java.util.Map" parameterType="java.lang.Long" >
    SELECT leixing, xiaomifeng_time, xiaomifeng, changdi, u3.username username, u3.create_time create_time, IF(DATE(xiaomifeng_time) >  DATE(u3.create_time), '小蜜蜂收集过期', '统计正常') status FROM
		base_user u3 
		INNER JOIN (
				SELECT '自动统计_场地推荐小蜜蜂' leixing, s1.changdi, u2.id, u2.username AS xiaomifeng, u2.create_time xiaomifeng_time FROM 
				(SELECT u1.id, u1.username AS changdi FROM base_user u1 WHERE u1.presenter_id = 7493076) s1
				INNER JOIN base_user u2 ON s1.id = u2.presenter_id
				UNION
				SELECT '手动统计_非场地推荐小蜜蜂' leixing, dd.district_name AS changdi, d.dsp_code AS id, u.username, d.create_time xiaomifeng_time  
					FROM dw.dict_business_district_detail d				
				INNER JOIN base_user u ON u.id = d.dsp_code	
				INNER JOIN dw.dict_business_district dd ON d.district_id = dd.id
				WHERE d.spread_type = 2300005 
				AND d.district_id IN(SELECT id FROM dw.dict_business_district WHERE parent_id = 5)
				AND d.dsp_code NOT IN(
					SELECT u2.id  FROM 
					(SELECT u1.id, u1.username AS changdi FROM base_user u1 WHERE u1.presenter_id = 7493076) s1
					INNER JOIN base_user u2 ON s1.id = u2.presenter_id
				)			
				
		) s2
		ON s2.id = u3.presenter_id
	WHERE u3.create_time >= #{startDate} AND u3.create_time <![CDATA[<]]> DATE(#{endDate}) + interval 1 day
	<if test="xiaomifeng != null and xiaomifeng != ''" >
	and xiaomifeng = #{xiaomifeng}
	</if>
	<if test="changdi != null and changdi != '-1'" >
	and changdi = #{changdi}
	</if>
	<if test="sort != null and sort != ''" >
	order by ${sort}
	</if>
	<if test="sort == null or sort == ''" >
	order by create_time desc
	</if>
	limit ${start},${length}
  </select>
  
  <select id="getXiaomifengByName" resultType="java.util.Map" parameterType="java.lang.Long">
  	select leixing,changdi, id,xiaomifeng,xiaomifeng_time
  	from
  	(
  	SELECT '自动统计_场地推荐小蜜蜂' leixing, s1.changdi, u2.id, u2.username AS xiaomifeng, u2.create_time xiaomifeng_time FROM 
				(SELECT u1.id, u1.username AS changdi FROM base_user u1 WHERE u1.presenter_id = 7493076) s1
				INNER JOIN base_user u2 ON s1.id = u2.presenter_id
				UNION
				SELECT '手动统计_非场地推荐小蜜蜂' leixing, dd.district_name AS changdi, d.dsp_code AS id, u.username, d.create_time xiaomifeng_time  
					FROM dw.dict_business_district_detail d				
				INNER JOIN base_user u ON u.id = d.dsp_code	
				INNER JOIN dw.dict_business_district dd ON d.district_id = dd.id
				WHERE d.spread_type = 2300005 
				AND d.district_id IN(SELECT id FROM dw.dict_business_district WHERE parent_id = 5)
				AND d.dsp_code NOT IN(
					SELECT u2.id  FROM 
					(SELECT u1.id, u1.username AS changdi FROM base_user u1 WHERE u1.presenter_id = 7493076) s1
					INNER JOIN base_user u2 ON s1.id = u2.presenter_id
				)	
	) xmf
	where xiaomifeng = #{xiaomifeng}
  </select>
  
  <select id="getXiaomifengUserByName" resultType="java.util.Map" parameterType="java.lang.Long">
  	select id,username from base_user where username = #{xiaomifeng}
  </select>
  
   <insert id="saveXiaomifeng" parameterType="java.util.Map" >
    insert into dict_business_district_detail
	(name,district_id,applicant,create_time,dsp_code,spread_type)
	values
	(
		#{xiaomifeng},
		(select id from dict_business_district where district_name = #{changdi} limit 1),
		'ticket',
		now(),
		(select id from base_user where username = #{xiaomifeng}),
		2300005
	)
  </insert>
  
  <select id="getChangdi" resultType="java.util.Map" parameterType="java.lang.Long" >
  	SELECT username id, username name FROM
	(SELECT u1.username FROM base_user u1 WHERE u1.presenter_id = 7493076
	UNION
	SELECT DISTINCT(dd.district_name) AS NAME
						FROM dw.dict_business_district_detail d	
					INNER JOIN dw.dict_business_district dd ON d.district_id = dd.id
					WHERE d.spread_type = 2300005 
					AND d.district_id IN(SELECT id FROM dw.dict_business_district WHERE parent_id = 5)) s
  </select>
  
  <select id="getTicketBeeCnt" resultType="java.lang.Integer" parameterType="java.lang.Long" >
    SELECT count(u3.id) FROM
		base_user u3 
		INNER JOIN (
				SELECT s1.changdi, u2.id, u2.username AS xiaomifeng, u2.create_time xiaomifeng_time FROM 
				(SELECT u1.id, u1.username AS changdi FROM base_user u1 WHERE u1.presenter_id = 7493076) s1
				INNER JOIN base_user u2 ON s1.id = u2.presenter_id
				UNION
				SELECT dd.district_name AS changdi, d.dsp_code AS id, u.username, d.create_time xiaomifeng_time  
					FROM dw.dict_business_district_detail d				
				INNER JOIN base_user u ON u.id = d.dsp_code	
				INNER JOIN dw.dict_business_district dd ON d.district_id = dd.id
				WHERE d.spread_type = 2300005 
				AND d.district_id IN(SELECT id FROM dw.dict_business_district WHERE parent_id = 5)
				AND d.dsp_code NOT IN(
					SELECT u2.id  FROM 
					(SELECT u1.id, u1.username AS changdi FROM base_user u1 WHERE u1.presenter_id = 7493076) s1
					INNER JOIN base_user u2 ON s1.id = u2.presenter_id
				)			
				
		) s2
		ON s2.id = u3.presenter_id
	WHERE u3.create_time >= #{startDate} AND u3.create_time <![CDATA[<]]> DATE(#{endDate}) + interval 1 day
	<if test="xiaomifeng != null and xiaomifeng != ''" >
	and xiaomifeng = #{xiaomifeng}
	</if>
	<if test="changdi != null and changdi != '-1'" >
	and changdi = #{changdi}
	</if>
  </select>
</mapper>